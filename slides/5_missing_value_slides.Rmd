---
title: "Handle Missing Values"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
   

---
class: inverse

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

```{r xaringan-tile-view, echo=FALSE}
xaringanExtra::use_tile_view()
```


```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

```{r, echo=FALSE}
xaringanExtra::use_webcam()
```

```{r xaringan-fit-screen, echo=FALSE}
xaringanExtra::use_fit_screen()
```

# New Functions

- colSums(is.na()), colMeans(is.na())

- na_if

- drop_na

- fill

- replace_na

- package: vis_dat, VIM

---
class: inverse, center, middle
# 1. Do you need to handle missing values?

---
class: inverse, center, middle
# No if just doing some calculations on the data

---
class: inverse

```{r}
library(tidyverse)
df <- read_csv('https://bryantstats.github.io/math421/data/titanic_missing.csv')
df %>% summarise(mean_age=mean(Age, na.rm=TRUE))
```

---
class: inverse, center, middle
# No if just doing Visualization

---
class: inverse
```{r}
df %>% ggplot(aes(x=Age, color=Sex))+
    geom_density()
```

---
class: inverse
When do you need to handle missing values

- When you know the values of the missing values


- When building predictive models

- Other cases?

---
class: inverse
# Checking 

---
class: inverse

```{r}
# Missing values by columns
colSums(is.na(df))
```
---
class: inverse

```{r}
# Missing values by columns
colMeans(is.na(df))
```

---
class: inverse

# Visualizing it

```{r}
library(visdat)
vis_miss(df)
```

---
class: inverse

# Visualizing it

```{r}
library(visdat)
vis_dat(df)
```

---
class: inverse
# Steps to Handle missing values

- Step 1: Identify Missing Values (NA, 'Unknown', 'Missing','9999'...) and Convert them to `NA`

- Step 2:  Either 

  - Remove them
  - Replace them 
  
     - Numeric Variables: 
          - (1) by the mean/ median 
          - (2) predicted values by some models
          
     - Categorical Variables: 
          - (1) the mode or make it a new category
          - (2) predicted values by some models    

---
class: inverse
# Step 1: Identify Missing Values and Convert them to `NA`

- Sometime the missing values are not in `NA`

```{r}
colSums(df=='Missing', na.rm = TRUE)
```


---
class: inverse, middle, center
# Handle it

---
class: inverse
# Convert all missing to NA 

```{r}
df <- na_if(df, 'Unknown')
df <- na_if(df, 'Missing')
df <- na_if(df, 'Not Available')

# OR Pipe
df <- df %>% na_if('Unknown') %>% na_if('Missing') %>% na_if('Not Available')
``` 

---
class: inverse
# Drop rows with missing values with drop_na

- Drop rows without `hospitalized` data

```{r}
drop_na(df)
```

---
class: inverse
```{r}
drop_na(df, Age, Sex)
```

---
class: inverse
# Drop columns with missing values

```{r}
df %>% select(-Age, -Sex)
```

---
class: inverse
# Fill in missing values with previous or next value

```{r}
df %>% fill(Age, Sex, Cabin, .direction = 'updown')
```

---
class: inverse
# Replace Missing values with replace_na

```{r}
# Replace by the mean (numeric variable)
mean_age <- mean(df$Age, na.rm=TRUE)
df$Age <- replace_na(df$Age, mean_age)
```

---
class: inverse
# Replace Missing values with replace_na

```{r}
# Replace by the majority (categorical variable)
majority_sex <- names(which.max(table(df$Sex)))
df$Sex <- replace_na(df$Sex, majority_sex)
```


---
class: inverse
# Replace Missing values with replace_na

```{r}
# Replace by the majority (categorical variable)
majority_class <- names(which.max(table(df$Pclass)))
df$Pclass <- replace_na(df$Pclass, majority_class)
```
---
class: inverse
# Step 1: Identify Missing Values and Convert them to `NA`

- Sometime the missing values are not in `NA`

```{r}


vis_expect(df, ~.x == 'Missing')
```
---
class: inverse
# Step 1: Identify Missing Values and Convert them to `NA`

- Sometime the missing values are not in `NA`

```{r}
colSums(df=='Missing'|df=='Unknown'|df=='Not Available'|is.na(df), na.rm = TRUE)
```
---
class: inverse
# Step 1: Identify Missing Values and Convert them to `NA`

- Sometime the missing values are not in `NA`

```{r}
vis_expect(df, function(x){x == 'Missing'|x=='Unknown'|x=='Not Available'})
```


---
class: inverse, middle, center
# Package VIM

---
```{r, warning=FALSE}
library(VIM)
df <- read_csv('https://bryantstats.github.io/math421/data/titanic_missing.csv')
df <- na_if(df, 'Unknown')
df <- na_if(df, 'Missing')
df <- na_if(df, 'Not Available')
```

---
```{r}
aggr(df)
```

---
class: inverse, middle, center
# Package vis_dat

---

```{r}
library(VIM)
df <- read_csv('https://bryantstats.github.io/math421/data/titanic_missing.csv')
vis_expect(df, is.na)
```

---

```{r}
vis_expect(df, ~.x == 'Missing')
```

---

```{r}
library(VIM)
vis_expect(df, function(x){x == 'Missing'|x=='Unknown'|x=='Not Available'|is.na(x)})
```
